#!/bin/sh

activitywatch_link="https://github.com/ActivityWatch/activitywatch/releases/download/v0.11.0/activitywatch-v0.11.0-linux-x86_64.zip"
aspell_link="https://ftp.gnu.org/gnu/aspell/dict/id/aspell5-id-1.2-0.tar.bz2"

node_version="v16.12"

# Add repository
echo "deb http://ftp.au.debian.org/debian/ bullseye main contrib non-free" | sudo tee --append /etc/apt/sources.list
echo "deb-src http://ftp.au.debian.org/debian/ bullseye main contrib non-free" | sudo tee --append /etc/apt/sources.list

# Keep Debian up to date
sudo apt --yes update

#
# Main package
#

# libssl-dev provides certificates for curl
# libdbus-1-dev and pkg-config required by i3status-rust and other apps, such as mousepad
# audio won't work without pulseaudio
# without `gstreamer1.0-pulseaudio` apps can't play sound (such workrave can't play .wav notification sound)
# `alsa-utils` provide amixer command. It is easier to use than built-in pactl
sudo apt-get install --yes --no-install-recommends \
     libssl-dev \
     blueman bluez pulseaudio-module-bluetooth \
     git etckeeper gnupg2 ssh ssh-agent curl stow rsync

#
# Utilities
#

# xclip required by pass to copy to clipboard
# python3-nautilus is for nautilus integration with mat2
sudo apt-get install --yes --no-install-recommends \
     flameshot copyq peek file-roller workrave \
     htop tar zip unzip unar unrar-free ncdu mat2 python3-nautilus borgbackup gparted \
     mpv gimp inkscape libreoffice libreoffice-gtk3 audacity \
     evince system-config-printer \
     aspell aspell-en \
     fd-find \
     markdown telnet

#
# Additional packages
#

sudo apt-get install --yes --no-install-recommends \
     docker.io docker-compose
sudo usermod -aG docker "$USER"
su - "$USER"

#
# Keyboards
#

python3 -m pip install --user qmk
sudo apt-get install --yes --no-install-recommends libhidapi-dev
# qmk setup -H /media/$USER/exts1/source/qmk_firmware
# qmk config user.keyboard=sofle/rev1 user.keymap=$USER user.name=$USER


#
# Bluetooth
#

# Start the GUI manager using `bluetooth` in rofi drun
# Then manage using PavuControl GUI.
sudo modprobe btusb
sudo systemctl enable bluetooth.service
sudo systemctl start bluetooth.service

#
# Shell
#

# fish
echo 'deb http://download.opensuse.org/repositories/shells:/fish:/release:/3/Debian_11/ /' | sudo tee /etc/apt/sources.list.d/shells:fish:release:3.list
curl -fsSL https://download.opensuse.org/repositories/shells:fish:release:3/Debian_11/Release.key | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/shells_fish_release_3.gpg > /dev/null
sudo apt update
sudo apt install fish

chsh -s "$(which fish)" # change default shell to fish

# Bash
sudo apt-get install --yes --no-install-recommends \
     shellcheck

#
# Work
#

curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

sudo apt-get install --yes --no-install-recommends \
     python3 python3-dev python3-venv python3-pip python3-setuptools

cargo install vivid fnm atuin bat zoxide watchexec-cli tokei
fnm use $node_version

# Starship
sh -c "$(curl -fsSL https://starship.rs/install.sh)"

# Js
# Fixed version global packages
mkdir nodebin && cd nodebin && npm init --yes
npm install --prefix "$HOME"/nodebin/ typescript-language-server svelte-language-server bash-language-server
npm install --prefix "$HOME"/nodebin/ prettier parcel
mv nodebin/ .nodebin

# Rust
# cargo install git-cliff dprint dioxus-cli cargo-udeps cargo-outdated cargo-tarpaulin microserver

# ripgrep
# cargo install --path . --features 'pcre2'

# Python
# these app need to be installed inside the project's venv
# pip install python-language-server pyls-black pyls-isort pyls-mypy
# pip install black mypy pylint ipdb

# `grip` is handy tool to render md file locally
pip install --user grip

pip install --user virtualfish
vf install
vf new --python python3 global

#
# Setup
#

echo "Installed base app. I will setup them for you."

# aw-qt
curl --location $activitywatch_link --output /tmp/activitywatch.zip
unzip /tmp/activitywatch.zip
sudo mv /tmp/activitywatch /opt/
sudo chown --recursive "$USER:$USER" /opt/activitywatch
sudo ln --symbolic /opt/activitywatch/aw-qt /usr/local/bin/aw-qt

# Additional aspell dictionaries
curl --location $aspell_link --output /tmp/aspell5-id.tar.bz2
tar --file /tmp/aspell5-id.tar.bz2 --extract
./tmp/aspell5-id-1.2-0/configure
sudo make --directory /tmp/aspell5-id-1.2-0/ install

## pass-otp
git clone https://github.com/tadfisher/pass-otp /tmp/pass-otp
sudo make --directory /tmp/pass-otp install

# Emacs
sudo apt-get build-dep emacs
inn libgccjit-10-dev
# ./autogen.sh
# ./configure --with-native-compilation --with-pgtk
# make or # make -j$(nproc)
# sudo make install

# Dotfiles
git clone https://github.com/azzamsa/dotfiles ~/dotfiles/
for d in ~/dotfiles/*/ ; do
    stow "$d" --no-folding
done

# Disable pc speaker
# echo "blacklist pcspkr" | sudo tee --append /etc/modprobe.d/nobeep.conf

# Python

# Set default python to python3
# in Debian, it points to python2
sudo update-alternatives --install /usr/bin/python python /usr/bin/python3 10
