#!/bin/sh

# Remove unused apps
sudo dnf remove --assumeyes virtualbox* anaconda-* tmux qemu-* Box2D

# General
sudo dnf update --assumeyes
sudo dnf install --assumeyes stow emacs ncdu workrave copyq \
  docker docker-compose libreoffice gimp inkscape neofetch pandoc nextcloud-client flameshot \
  gparted foliate

# HEIF image supports
sudo dnf install --assumeyes https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-"$(rpm -E %fedora)".noarch.rpm https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-"$(rpm -E %fedora)".noarch.rpm
sudo dnf install --assumeyes libheif gimp-heif-plugin

# Terminal
sudo dnf install --assumeyes zsh fira-code-fonts
# Rustup
sudo dnf install --assumeyes lld make gcc
# Rust OpenSSL
sudo dnf install --assumeyes pkg-config openssl-devel
# Gnome Pano
sudo dnf install --assumeyes libgda libgda-sqlite
# Gnome Totem
sudo dnf install --assumeyes gstreamer1-plugin-openh264 mozilla-openh264

# Setup Docker
sudo setfacl --modify user:username:rw /var/run/docker.sock

# Setup Rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
rustup toolchain install nightly

# Use lld as default linker
tee -a ~/.cargo/config <<EOF
[target.x86_64-unknown-linux-gnu]
rustflags = [ "-Clink-arg=-fuse-ld=lld", "-Clink-arg=-Wl,--no-rosegment" ]
EOF

# Setup Rust Utilities
sudo dnf install --assumeyes tokei fd-find exa

cargo binstall --no-confirm --no-symlinks cargo-edit cargo-watch cargo-tarpaulin
cargo binstall --no-confirm --no-symlinks watchexec-cli cargo-outdated just fnm broot sytlua \
  --install-path ~/.local/bin

# Setup Sh Utilities
sudo dnf install --assumeyes shellcheck

# Setup Python Utilities
pip install --user pipenv grip black pylint

# Setup Web Utilities
sudo dnf install --assumeyes tidy

# Dotfiles
git clone https://github.com/azzamsa/dotfiles ~/dotfiles/
for d in ~/dotfiles/*/; do
  stow "$d" --no-folding
done

# Install apps from with flatpak
flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
flatpak update
flatpak install flathub com.logseq.Logseq org.keepassxc.KeePassXC com.mattjakeman.ExtensionManager org.mozilla.Thunderbird

# Download rpm files manually
# https://github.com/wez/wezterm/releases
# https://github.com/Kong/insomnia/releases
# https://dbeaver.io/download/

# Download binary
# https://github.com/restic/restic/releases
# https://github.com/oniony/TMSU/releases
# https://github.com/talklittle/tmsu-nautilus-rs/releases

# Move files from previous machine
# .gnupg fonts .nodebin .ssh .emacs .doom .config/insomnia

# Setup Doom
doom sync
# doom doctor

# Setup ripgrep with pcre2 feature
mkdir -p /opt/ripgrep
sudo chown --recursive "$USER:$USER" /opt/activitywatch
git clone --depth 1 git@github.com:BurntSushi/ripgrep.git /opt/ripgrep
cargo install --path /opt/ripgrep --features 'pcre2'

# Post Setup
sudo dnf autoremove
sudo dnf clean packages

# Clean locales
mkdir /tmp/locales
sudo mv en* locale.alias /tmp/locales
sudo rm -rf /usr/share/locale/*
sudo mv /tmp/locales/* /usr/share/locale/

sudo rm -rf /var/tmp/* /tmp/*

sudo journalctl --rotate
sudo journalctl --vacuum-time=1s

docker system prune -a

rm -rf ~/.cargo/git/* ~/.cargo/registry/*

# Troubeshooting

# Workrave
# Exec=env GDK_BACKEND=x11 workrave
# in /usr/share/applications/workrave
