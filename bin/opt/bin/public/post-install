#!/bin/bash

# Upgarde
rpm-ostree status
rpm-ostree upgrade --check
rpm-ostree upgrade

# Basic Packages
rpm-ostree install --apply-live zsh nnn wl-clipboard libgda libgda-sqlite tlp tlp-rdw gnome-tweaks
systemctl reboot
rpm-ostree override remove firefox firefox-langpacks
systemctl reboot

# Dotfles
stow --no-folding --restow bin git gnupg vi zsh zellij popd >/dev/null || exit
# Set ZSH to as default
sudo usermod -s /bin/zsh $USERNAME

# NVIDIA
rpm-ostree install --apply-live https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm https://download1.rpmfusio
n.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm
systemctl reboot
rpm-ostree install --apply-live akmod-nvidia xorg-x11-drv-nvidia xorg-x11-drv-nvidia-cuda
systemctl reboot

# Setup TLP
rpm-ostree override remove power-profiles-daemon
sudo systemctl enable tlp.service
sudo systemctl mask systemd-rfkill.service systemd-rfkill.socket
# set `STOP_CHARGE_THRESH_BAT0="1"` in `/etc/tlp.conf``
sudo tlp start\nsudo tlp-stat -s -c -b

# Rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
rustup default stable

# Install apps from with flatpak
flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
flatpak update
flatpak install --assumeyes flathub org.gnome.Firmware org.telegram.desktop com.logseq.Logseq org.keepassxc.KeePassXC \
  com.mattjakeman.ExtensionManager org.mozilla.firefox org.mozilla.Thunderbird org.videolan.VLC org.kde.okular \
  io.github.seadve.Kooha fr.romainvigier.MetadataCleaner us.zoom.Zoom \
  com.github.johnfactotum.Foliate io.dbeaver.DBeaverCommunity org.inkscape.Inkscape \
  org.gimp.GIMP com.github.tchx84.Flatseal io.github.celluloid_player.Celluloid \
  org.libreoffice.LibreOffice net.hovancik.Stretchly org.gustavoperedo.FontDownloader \
  com.github.maoschanz.drawing rest.insomnia.Insomnia com.calibre_ebook.calibre \
  org.gnome.FileRoller org.gnome.Boxes org.gnome.seahorse.Application

# Toolboxes
toolbox create base
toolbox enter base
# Tools
sudo dnf install --assumeyes zsh emacs neofetch nnn jq ShellCheck tidy python3.11-pip
python3 -m pip install --user grip
# Emacs
doom sync && doom doctor
# create a base image
podman stop base
podman commit base
  
# Rust Toolbox
toolbox create -i base rust
toolbox enter rust
sudo dnf install --assumeyes @development-tools clang mold
# Setup Rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
. "$HOME/.cargo/env"
# Use rust toolbox to install cargo apps
cargo binstall --no-confirm --no-symlinks cargo-edit cargo-watch cargo-tarpaulin watchexec-cli cargo-outdated just fnm stylua starship \
  bat genact dua-cli atuin zoxide zellij rust-script evcxr_repl bandwhich hurl kondo git-cliff dprint cargo-nextest

# Python Toolbox
toolbox create -i base python
toolbox enter python
sudo dnf install --assumeyes python3.11 python3.11-devel python3.11-pip

# Javascript
toolbox create -i base javascript
toolbox enter javascript
fnm use v18

# GNOME Extensions
# - https://extensions.gnome.org/extension/5278/pano/
# - https://extensions.gnome.org/extension/2980/internet-speed-meter/
# - https://extensions.gnome.org/extension/36/lock-keys/
# - https://extensions.gnome.org/extension/1625/soft-brightness/
# - https://extensions.gnome.org/extension/615/appindicator-support/

# VPN
# - https://account.proton.me/u/0/vpn/OpenVpnIKEv2

# Setup ripgrep with pcre2 feature
mkdir -p ~/opt/ripgrep
git clone --depth 1 https://github.com/BurntSushi/ripgrep.git ~/opt/ripgrep
cargo install --path ~/opt/ripgrep --features 'pcre2'

# Download binary manually
# https://github.com/mvdan/sh/releases
# https://github.com/restic/restic/releases
# https://github.com/oniony/TMSU/releases
# https://github.com/talklittle/tmsu-nautilus-rs/releases
