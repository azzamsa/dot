#!/usr/bin/env rust-script
//! Update
//!
//! Update applications.
//!
//! Usage:
//!
//! Just run it as normal executable file:
//!
//! ```shell
//! $ ./update
//! ```
//!
//! ```cargo
//! [dependencies]
//! xshell = "0.2"
//! anyhow = "1.0"
//! ```
use xshell::{cmd, Shell};

fn home() -> anyhow::Result<String> {
    Ok(std::env::var("HOME")?)
}

fn run() -> anyhow::Result<()> {
    let sh = Shell::new()?;

    println!("ðŸŒ± Updating flatpak apps");
    cmd!(sh, "flatpak update").run()?;

    println!("ðŸŒ± Upgrading system");
    cmd!(sh, "rpm-ostree upgrade --preview").run()?;

    println!("ðŸŒ± Checking node apps");
    {
        let home = home()?;
        let _d = sh.push_dir(format!("{home}/opt/nodebin"));
        cmd!(sh, "taze major --write").run()?;
        cmd!(sh, "npm i").run()?;
    }

    println!("ðŸŒ± Checking rust apps");
    cmd!(sh, "rustup check").run()?;
    cmd!(sh, "cargo install-update -a").run()?;

    Ok(())
}

fn main() -> anyhow::Result<()> {
    run()?;
    println!("âœ¨ You have a new shiny machine!");

    Ok(())
}
